<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tài khoản - B4E</title>
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/headerfooter.css" rel="stylesheet">
    <link href="css/accountmanage.css" rel="stylesheet">

</head>
<body>

    <div id="main-header"></div>

    <div class="container">
        <h2>Quản lý Tài khoản</h2>
        <p>Chỉnh sửa thông tin cá nhân của bạn.</p>
        
        <form id="profileForm">
            <div class="form-group">
                <label for="email">Email (Không thể thay đổi)</label>
                <input type="email" id="email" name="email" disabled>
            </div>
            
            <div class="form-group">
                <label for="username">Tên hiển thị (Username)</label>
                <input type="text" id="username" name="username" required>
            </div>
            
            <div class="form-group">
                <label for="phone">Số điện thoại</label>
                <input type="tel" id="phone" name="phone" required>
            </div>
            
            <div class="form-group">
                <label for="address">Địa chỉ</label>
                <textarea id="address" name="address" rows="4" required></textarea>
            </div>
            
            <button type="submit" class="btn-submit">Lưu Thay Đổi</button>
        </form>
    </div>

    <div id="main-footer"></div>

    <script src="js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const token = localStorage.getItem('b4e_token');
            // Lấy các ô input
            const emailInput = document.getElementById('email');
            const usernameInput = document.getElementById('username');
            const phoneInput = document.getElementById('phone');
            const addressInput = document.getElementById('address');
            const profileForm = document.getElementById('profileForm');

            // HÀM 1: LẤY THÔNG TIN KHI TẢI TRANG
            async function loadProfile() {
                if (!token) {
                    alert('Bạn cần đăng nhập để xem trang này.');
                    window.location.href = 'login.html';
                    return;
                }

                const apiUrl = '/api/auth/get_profile.php';

                try {
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('b4e_token');
                        localStorage.removeItem('b4e_user');
                        window.location.href = 'login.html';
                        return;
                    }

                    if (!response.ok) {
                        throw new Error('Lỗi khi tải thông tin cá nhân.');
                    }
                    
                    const user = await response.json();

                    // Điền thông tin vào form
                    emailInput.value = user.email;
                    usernameInput.value = user.username;
                    phoneInput.value = user.phone || ''; // Hiển thị rỗng nếu là null
                    addressInput.value = user.address || ''; // Hiển thị rỗng nếu là null

                } catch (error) {
                    console.error('Lỗi:', error);
                    alert(error.message);
                }
            }

            // HÀM 2: GỬI CẬP NHẬT KHI SUBMIT FORM
            profileForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const updatedData = {
                    username: usernameInput.value,
                    phone: phoneInput.value,
                    address: addressInput.value
                };

                const apiUrl = '/B4Eproject/api/auth/update_profile.php';

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify(updatedData)
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        // Hiển thị lỗi từ server (ví dụ: username trùng)
                        throw new Error(result.error || 'Lỗi không xác định');
                    }
                    
                    // Cập nhật localStorage VỚI THÔNG TIN MỚI
                    localStorage.setItem('b4e_user', JSON.stringify(result.user));
                    
                    alert(result.message); // "Cập nhật thông tin thành công."
                    
                    // Tải lại trang để header (chào, user) cũng được cập nhật
                    location.reload();

                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi: ' + error.message);
                }
            });

            // Chạy hàm load profile ngay khi DOM đã tải xong
            loadProfile();
        });
    </script>

</body>
</html>